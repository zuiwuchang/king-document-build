var NewChapter=function(p){var c=p.Language,a=!0,l=$("#idChapterMsg"),h=function(c,a){var e="<div class='alert ";l.html((1==a?e+"alert-info":2==a?e+"alert-warning":3==a?e+"alert-danger":e+"alert-success")+("' role='alert'>"+c+"</div>"));l.show("fast")},q=$("#idChapterBodyView"),t=$("#idChapterBodyHide");$("#idChapterHide").click(function(c){t.toggle("fast");q.toggle("fast")});var v=function(){var c=$("#idBtnSort"),a=$("#idModalSortBody");a.sortable().disableSelection();var e=$("#idModalSortSure"),
h=$("#idModalSortCancel"),b=null,d=null;e.click(function(f){h.click();if(b){var c=[],g=!1;a.children("li").each(function(b,f){var a=$(f).data("id");c.push({Id:a,Sort:b});g||a==d[b].Id||(g=!0)});g&&b(c)}});return{Show:function(f,u){d=f;b=u;for(var g="",k=0;k<f.length;k++)var e=f[k],g=g+("<li class='list-group-item' data-id='"+e.Id+"'>"+e.Name+"</li>");a.html(g);c.click()}}}(),w=kingui,m=function(a){var h=null,e={Hide:function(){l.Hide()},Show:function(b,d,a){h=a;l.Show(b,d)}},l=w.NewMsg({Id:a,Btns:[{Name:c.Sure,
Callback:function(){h?h.bind(e)():this.Hide()}},{Name:c.Cancel}]});return e},n=1,x=m(n++),r=m(n++);(function(){var m=function(b,d){if(a){a=!1;var f=c["new name"];$.ajax({url:"/Chapter/AjaxNew",type:"POST",dataType:"json",data:{doc:p.Id,name:f}}).done(function(a){0==a.Code?(a=b.create_node(d,{id:a.Value,parent:"0",text:f}),b.edit(a)):h(a.Emsg,3)}).fail(function(){h(c["err net"],3)}).always(function(){a=!0})}},n=function(b,d){if(a){for(var f=[],e=0;e<d.children.length;++e){var g=b.get_node(d.children[e]);
f.push({Id:g.id,Name:g.text})}v.Show(f,function(f){if(a){a=!1;b.set_icon(d,"/public/img/throbber.gif");l.hide("fast");var e=JSON.stringify(f);$.ajax({url:"/Chapter/AjaxSort",type:"POST",dataType:"json",data:{str:e}}).done(function(a){if(0==a.Code){for(a=0;a<f.length;a++){var c=f[a];b.get_node(c.Id).data=c.Sort}b.close_node(d);b.sort(d);b.open_node(d)}else h(a.Emsg,3)}).fail(function(){h(c["err net"],3)}).always(function(){b.set_icon(d);a=!0})}})}},e=function(b,d){a&&(a=!1,$.ajax({url:"/Chapter/AjaxRemove",
type:"POST",dataType:"json",data:{id:d.id}}).done(function(a){0==a.Code?b.delete_node(d):r.Show(c["err.title"],a.Emsg)}).fail(function(){r.Show(c["err.title"],c["err net"])}).always(function(){a=!0}))},q=function(b,d){if(a){var f=c.erase+" - "+b.get_text(d)+"<br/>"+c["sure?"];x.Show(c["msg warning"],f,function(){this.Hide();e(b,d)})}};$("#idChapterTree").jstree({plugins:["conditionalselect","contextmenu","sort"],conditionalselect:function(){this.deselect_all(!0);return!0},contextmenu:{items:function(b){var d=
this;return"0"==b.id?{create:{label:c["menu new"],icon:"/public/img/add_16px.ico",action:function(){m(d,b)}},sort:{label:c["menu sort"],icon:"/public/img/sort_16px.ico",separator_before:!0,action:function(){n(d,b)}}}:{view:{label:c["menu view"],icon:"/public/img/cloud_16px.ico",action:function(){window.open("/Chapter?id="+b.id)}},edit:{label:c["menu edit"],icon:"/public/img/wrench_16px.ico",action:function(){window.open("/Edit?id="+b.id)}},rename:{label:c["menu rename"],icon:"/public/img/why_16px.ico",
separator_before:!0,action:function(){a&&d.edit(b)}},remove:{label:c["menu remove"],icon:"/public/img/close_16px.ico",separator_before:!0,action:function(){a&&q(d,b)}}}}},sort:function(a,d){var b=this.get_node(a),c=this.get_node(d);return b.data>c.data?1:-1},core:{check_callback:!0,data:p.Data}}).on("rename_node.jstree",function(b,d){var f=$(this).jstree(!0),e=d.node,g=d.text,k=d.old;g!=k&&(a?(a=!1,f.set_icon(e,"/public/img/throbber.gif"),l.hide("fast"),$.ajax({url:"/Chapter/AjaxRename",type:"POST",
dataType:"json",data:{id:e.id,name:g}}).done(function(a){0!=a.Code&&(h(a.Emsg,3),f.set_text(e,k))}).fail(function(){h(c["err net"],3);f.set_text(e,k)}).always(function(){f.set_icon(e);a=!0})):f.set_text(e,k))})})()};

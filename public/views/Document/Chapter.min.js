var NewChapter=function(p){var c=p.Language,a=!0,l=$("#idChapterMsg"),g=function(c,a){var e="<div class='alert ";l.html((1==a?e+"alert-info":2==a?e+"alert-warning":3==a?e+"alert-danger":e+"alert-success")+("' role='alert'>"+c+"</div>"));l.show("fast")},q=$("#idChapterBodyView"),t=$("#idChapterBodyHide");$("#idChapterHide").click(function(c){t.toggle("fast");q.toggle("fast")});var u=function(){var c=$("#idBtnSort"),a=$("#idModalSortBody");a.sortable().disableSelection();var e=$("#idModalSortSure"),
g=$("#idModalSortCancel"),b=null,d=null;e.click(function(f){g.click();if(b){var h=[],c=!1;a.children("li").each(function(b,f){var a=$(f).data("id");h.push({Id:a,Sort:b});c||a==d[b].Id||(c=!0)});c&&b(h)}});return{Show:function(f,h){d=f;b=h;for(var e="",k=0;k<f.length;k++)var g=f[k],e=e+("<li class='list-group-item' data-id='"+g.Id+"'>"+g.Name+"</li>");a.html(e);c.click()}}}(),v=kingui,m=function(a){var g=null,e={Hide:function(){l.Hide()},Show:function(b,d,a){g=a;l.Show(b,d)}},l=v.NewMsg({Id:a,Btns:[{Name:c.Sure,
Callback:function(){g?g.bind(e)():this.Hide()}},{Name:c.Cancel}]});return e},n=1,w=m(n++),r=m(n++);(function(){var m=function(b,d){if(a){a=!1;var f=c["new name"];$.ajax({url:"/Chapter/AjaxNew",type:"POST",dataType:"json",data:{doc:p.Id,name:f}}).done(function(a){0==a.Code?(a=b.create_node(d,{id:a.Value,parent:"0",text:f,data:parseInt(a.Str)}),b.edit(a)):g(a.Emsg,3)}).fail(function(){g(c["err net"],3)}).always(function(){a=!0})}},n=function(b,d){if(a){for(var f=[],h=0;h<d.children.length;++h){var e=
b.get_node(d.children[h]);f.push({Id:e.id,Name:e.text})}u.Show(f,function(f){if(a){a=!1;b.set_icon(d,"/public/img/throbber.gif");l.hide("fast");var e=JSON.stringify(f);$.ajax({url:"/Chapter/AjaxSort",type:"POST",dataType:"json",data:{str:e}}).done(function(a){if(0==a.Code){for(a=0;a<f.length;a++){var c=f[a];b.get_node(c.Id).data=c.Sort}b.close_node(d);b.sort(d);b.open_node(d)}else g(a.Emsg,3)}).fail(function(){g(c["err net"],3)}).always(function(){b.set_icon(d);a=!0})}})}},e=function(b,d){a&&(a=!1,
$.ajax({url:"/Chapter/AjaxRemove",type:"POST",dataType:"json",data:{id:d.id}}).done(function(a){0==a.Code?b.delete_node(d):r.Show(c["err.title"],a.Emsg)}).fail(function(){r.Show(c["err.title"],c["err net"])}).always(function(){a=!0}))},q=function(b,d){if(a){var f=c.erase+" - "+b.get_text(d)+"<br/>"+c["sure?"];w.Show(c["msg warning"],f,function(){this.Hide();e(b,d)})}};$("#idChapterTree").jstree({plugins:["conditionalselect","contextmenu","sort"],conditionalselect:function(){this.deselect_all(!0);
return!0},contextmenu:{items:function(b){var d=this;return"0"==b.id?{create:{label:c["menu new"],icon:"/public/img/add_16px.ico",action:function(){m(d,b)}},sort:{label:c["menu sort"],icon:"/public/img/sort_16px.ico",separator_before:!0,action:function(){n(d,b)}}}:{view:{label:c["menu view"],icon:"/public/img/cloud_16px.ico",action:function(){window.open("/Chapter?id="+b.id)}},edit:{label:c["menu edit"],icon:"/public/img/wrench_16px.ico",action:function(){window.open("/Edit?id="+b.id)}},rename:{label:c["menu rename"],
icon:"/public/img/why_16px.ico",separator_before:!0,action:function(){a&&d.edit(b)}},remove:{label:c["menu remove"],icon:"/public/img/close_16px.ico",separator_before:!0,action:function(){a&&q(d,b)}}}}},sort:function(a,d){var b=this.get_node(a),c=this.get_node(d);return b.data>c.data?1:-1},core:{check_callback:!0,data:p.Data}}).on("rename_node.jstree",function(b,d){var f=$(this).jstree(!0),e=d.node,m=d.text,k=d.old;m!=k&&(a?(a=!1,f.set_icon(e,"/public/img/throbber.gif"),l.hide("fast"),$.ajax({url:"/Chapter/AjaxRename",
type:"POST",dataType:"json",data:{id:e.id,name:m}}).done(function(a){0!=a.Code&&(g(a.Emsg,3),f.set_text(e,k))}).fail(function(){g(c["err net"],3);f.set_text(e,k)}).always(function(){f.set_icon(e);a=!0})):f.set_text(e,k))})})()};
